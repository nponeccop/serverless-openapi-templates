# Very minimum

- `serverless create --template=aws-nodejs` - smallest of the templates
- `sed -i '/^#/d;/^$/d' serverless.yml` - delete comments
- `serverless deploy` - deploy hello: min-dev-hello and nothing else
- `jq '.Resources|map_values(.Type)' .serverless/cloudformation-template-*`
```json
{
  "ServerlessDeploymentBucket": "AWS::S3::Bucket",
  "ServerlessDeploymentBucketPolicy": "AWS::S3::BucketPolicy"
}
```

```json
{
  "ServerlessDeploymentBucket": "AWS::S3::Bucket",
  "ServerlessDeploymentBucketPolicy": "AWS::S3::BucketPolicy",
  "HelloLogGroup": "AWS::Logs::LogGroup",
  "IamRoleLambdaExecution": "AWS::IAM::Role",
  "HelloLambdaFunction": "AWS::Lambda::Function",
  "HelloLambdaVersionh6hfIK7ed0UWMENGZpRJoqXm2HhgzuIOzJaq1cD2nk": "AWS::Lambda::Version"
}
```

- No APIGatewayV2 is in sight, so go to APIGateway in AWS Console
- Create, Create Integrations, Lambda, {your region}, min-dev-hello, 2.0
- APIName = Serverless Minimal OpenAPI, as it's purely decorative
- Next
- Method=POST, leave everything else as is
- Next, Create
- You get "Successfully created API Serverless Minimal OpenAPI" green banner
- Go to Develop > Export in the sidebar
- rename the downloaded file to `openapi.yml` and put it next to `serverless.yml`
- Note that:
  - `info.title` is "Serverless Minimal OpenAPI". It isn't used as an identifier anywhere,
    but as a human-readable title in the ApiGateway console
  - `info.version` is autogenerated and doesn't seem to be used anywhere. You can use it
    as your API version in your public API documentation, or somethng like that
  - `servers` contain your `execute-api` domain name
  - stage name is `$default`, which lets you avoid that nasty `dev` stage name if you have
    only one stage. Deploying multiple stages in the same AWS account is almost useless,
    as e.g. DynamoDB doesn't have stages. And any project has multiple accounts, it's
    normal to have many if security is of any concern, as accounts are really
    the recommended security boundaries for PCI DSS/HIPAA/whatever. So I guess it's
    better to use `$default` in Serverless templates as it's a saner default, but I digress
  - `/min-dev-hello` in paths is a URI, you can change it independently from
    the lambda name
  - the lambda name `hello` from `serverless.yml` is in `x-amazon-apigateway-integration.uri`
  - `x-amazon-apigateway-integration.method` and `paths./min-dev-hello.post` are duplicates for
    a reason yet unclear to me
  - Now you can change openapi.yml and go to Develop > Reimport to change.

  Ok, so this is a very basic manual OpenAPI-based setup. The next step is to plug it into `serverless.yml` so it creates an OpenAPI-based ApiGatewayV2 by importing `openapi.yml` during deployment.

# Import openapi.yml using serverless.yml

Now we create the HttpApi resource manually in the `resources` section:

```yaml
resources:
  Resources:
    HttpApi:
      Type: AWS::ApiGatewayV2::Api
      Properties:
        Body: ${file(openapi.yml)}
```

Note that some of the properties Serverless normally puts to the ApiGatewayV2 are not allowed,
beause they are taken from the OpenAPI spec instead. Serverless converts the `.yml` file into JSON
while plugging it into the CloudFormation templates, and it works just fine.

To deploy, you need to clean up first:
- `serverless remove`
- manually remove the gateway in the AWS Console
